#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <execinfo.h>
#include "libgotoku.h"
#include <sys/types.h>
#include <stdint.h>
#include <dlfcn.h>
#include <sys/mman.h>

#define GAMEPFX "GOTOKU: "

int main_offset = 112617;
uintptr_t got_offset[] = {134360, 139064, 134248, 139104, 134704, 139480, 134656, 138184, 143080, 139808, 134992, 139864, 135048, 139920, 135744, 140544, 135872, 140696, 135856, 133744, 138608, 133792, 138656, 133840, 138688, 134464, 139320, 134584, 139456, 142264, 137472, 142352, 137488, 142392, 137576, 142456, 138096, 142944, 138256, 136152, 140960, 136168, 141056, 136200, 141080, 136248, 141128, 136928, 141800, 136160, 141024, 136232, 141096, 136096, 140928, 136112, 140952, 136272, 141168, 139768, 135000, 139872, 134888, 139664, 134920, 139688, 135056, 139928, 134944, 138664, 133752, 138496, 133680, 138536, 133696, 138696, 133896, 138616, 133736, 142400, 137424, 142208, 137448, 142240, 137592, 142472, 137480, 142344, 137176, 140920, 136104, 140944, 136264, 141160, 136176, 140992, 135944, 140744, 136256, 141920, 136960, 141792, 137368, 142128, 137224, 142184, 137432, 142200, 137440, 143008, 138088, 143016, 138112, 142936, 138456, 143248, 138352, 143288, 138488, 139400, 134504, 139336, 134528, 139368, 134448, 139640, 134800, 139560, 134824, 140584, 135808, 140608, 135736, 140624, 135752, 140536, 136048, 140856, 135976, 137336, 141848, 137000, 141872, 136920, 141912, 136952, 141784, 137360, 142120, 137160, 142192, 137392, 142152, 137296, 142168, 137264, 142088, 137528, 142424, 143312, 138464, 143272, 138400, 143296, 138376, 143232, 138672, 133800, 138360, 134872, 139616, 134792, 139632, 134760, 139592, 134984, 139880, 134736, 139856, 140864, 136024, 140888, 136000, 140832, 136192, 141104, 135984, 141088, 136328, 142160, 137256, 142080, 137520, 142416, 137232, 142384, 137640, 142448, 137584, 141432, 136768, 141464, 136624, 141888, 136992, 141776, 137032, 141960, 137048, 135592, 140280, 135488, 140640, 135792, 140552, 135824, 140680, 135848, 140688, 139152, 134216, 139168, 134240, 139040, 134536, 139384, 134456, 139408, 134544, 142800, 137944, 142696, 137952, 142736, 137840, 143048, 138136, 142952, 138152, 136664, 141528, 136704, 141424, 136760, 141456, 136616, 141880, 136984, 141768, 140616, 135536, 140344, 135568, 140256, 135584, 140272, 135480, 140632, 135784, 142920, 138176, 143056, 138144, 142992, 138160, 142960, 138120, 143160, 138304, 137040, 141936, 137016, 141856, 137024, 141816, 136968, 142008, 137184, 141808, 140664, 135800, 140592, 135832, 140568, 135768, 140712, 135952, 140560, 135936, 134496, 139376, 134520, 139344, 134480, 139512, 134712, 139328, 134688, 139584, 141144, 136736, 141504, 136608, 141568, 136800, 141600, 136824, 141536, 136184, 137608, 142544, 137656, 142440, 137976, 142776, 137872, 142816, 137992, 142864, 134032, 138800, 133864, 139192, 134272, 139048, 134304, 139208, 134368, 139232, 140032, 135080, 140064, 135112, 139888, 135600, 140328, 135496, 140360, 135640, 136400, 141248, 136288, 141312, 136312, 141136, 136728, 141496, 136600, 141560, 142504, 137696, 142528, 137600, 142536, 137648, 142432, 137968, 142768, 137864, 139136, 133936, 138864, 133984, 138728, 134024, 138792, 133856, 139184, 134264, 134184, 139176, 134336, 139120, 134256, 139160, 134224, 139096, 134424, 139312, 140376, 135624, 140336, 135552, 140368, 135512, 140312, 135688, 140528, 135504, 136776, 141544, 136688, 141552, 136648, 141480, 136888, 141760, 136632, 141752, 140808, 135968, 141272, 136384, 141120, 136432, 141360, 136488, 141376, 136408, 134728, 140080, 135200, 139904, 135272, 140136, 135328, 140152, 135224, 139488, 143184, 138448, 143224, 138344, 134056, 138848, 133888, 138872, 134104, 138944, 137352, 142056, 137200, 142584, 137680, 142464, 137712, 142616, 137752, 142632, 136040, 140784, 136080, 140800, 135960, 141264, 136376, 141112, 136424, 141352, 139608, 134816, 139552, 134840, 139568, 134720, 140072, 135192, 139896, 135264, 138392, 143256, 138424, 143176, 138440, 143216, 138336, 134048, 138840, 133880, 142520, 137288, 142136, 137328, 142032, 137344, 142048, 137192, 142576, 137672, 139816, 135288, 140112, 135232, 140000, 135280, 139944, 135160, 140200, 135472, 134040, 138912, 133968, 138808, 133992, 138736, 133928, 139024, 134200, 138712, 136144, 141016, 136224, 141048, 136240, 141072, 137744, 142560, 137768, 142608, 142312, 137512, 142336, 137568, 142376, 138936, 134016, 138976, 134096, 138832, 135136, 138528, 133728, 138568, 133784, 138600, 133832, 138648, 135320, 140104, 139720, 134936, 139760, 134976, 139784, 135032, 139848, 136472, 141304, 136520, 141064, 137736, 142552, 137760, 142600, 137664, 142512, 137704, 142592, 137816, 137560, 142368, 138928, 134008, 138968, 134088, 138824, 133960, 138888, 134064, 138592, 133824, 138640, 135312, 140096, 135352, 140128, 135184, 140016, 135256, 134968, 139776, 135024, 139840, 136464, 141296, 136512, 141336, 136368, 141232, 137112, 141984, 137072, 141824, 137632, 140984, 136136, 141008, 136216, 141040, 143104, 138216, 142968, 138760, 142288, 137464, 142304, 137504, 142328, 137552, 135896, 140736, 135912, 140768, 135928, 142224, 137384, 142256, 137416, 142104, 140824, 134600, 139472, 134624, 139504, 134648, 139536, 134680, 140912, 136072, 143112, 138280, 143120, 138296, 143136, 138320, 143152, 139656, 134856, 139704, 137168, 133672, 138432, 133704, 138480, 143240, 138408, 143280, 138472, 133760, 140760, 135920, 142216, 137376, 142248, 137408, 142096, 137304, 142144, 137400, 134640, 139528, 134672, 140904, 136064, 140936, 136088, 140848, 136032, 140880, 138288, 143128, 138312, 143144, 139648, 134848, 139696, 134880, 139600, 134808, 142880, 138024, 142856, 137912, 143192, 137128, 141992, 137144, 142000, 137152, 136816, 141592, 136656, 142040, 135880, 140704, 135888, 140728, 135904, 140752, 140408, 135528, 140816, 134592, 139464, 134616, 139496, 134632, 139520, 134664, 136936, 140440, 135672, 140464, 135704, 140488, 135728, 140512, 137088, 141904, 141672, 136840, 141696, 136880, 141720, 136904, 141744, 138208, 143032, 138248, 138072, 134552, 139416, 134576, 139440, 134488, 139392, 134512, 139424, 134696, 134440, 139304, 135840, 140648, 135864, 140672, 135776, 140600, 135816, 140656, 140480, 135720, 140504, 137080, 141896, 137120, 141944, 136976, 141864, 137008, 136872, 141712, 136896, 141736, 138200, 143024, 138240, 143064, 138128, 143000, 134152, 138952, 134120, 138776, 134472, 138032, 142896, 138056, 142928, 138064, 140160, 135336, 139960, 135760, 139264, 134392, 139288, 134416, 139296, 134432, 136480, 141208, 136944, 140432, 135664, 140456, 135696, 140472, 135712, 140496, 142488, 138104, 141664, 136832, 141688, 136864, 141704, 136912, 141728, 138192, 135376, 140184, 135416, 140224, 135440, 140248, 135464, 141624, 136752, 141656, 134192, 140392, 135608, 140416, 135632, 140320, 135560, 140352, 135616, 140520, 137832, 142680, 139216, 134320, 139240, 134352, 139112, 134296, 139144, 134328, 136568, 141416, 136584, 142848, 137960, 142872, 137984, 142760, 137920, 142808, 140216, 135432, 140240, 135456, 141616, 136744, 141648, 136784, 141488, 136696, 139736, 134912, 139680, 134776, 140296, 134144, 139000, 134168, 139016, 134176, 133688, 138504, 143208, 139072, 142648, 137792, 142664, 137808, 142672, 137824, 142232, 137280, 142728, 136536, 141392, 136552, 141400, 136560, 141408, 136576, 136016, 141448, 135368, 140176, 135408, 140208, 135424, 140232, 135448, 141608, 134896, 139744, 134864, 139728, 134904, 139672, 134768, 140288, 134136, 138992, 137544, 142360, 138920, 134000, 138960, 134080, 138816, 133952, 138880, 134072, 138584, 133816, 138632, 135304, 140088, 135344, 140120, 135176, 140008, 135248, 134960, 139800, 135016, 139832, 136456, 141288, 136504, 141328, 136360, 141224, 137104, 141976, 137064, 141840, 137624, 140976, 136128, 141000, 136208, 141032, 143096, 138232, 142984, 138752, 142280, 137456, 142296, 137496, 142320, 137536, 134568, 139360, 135128, 138520, 133720, 138560, 133776, 138576, 133808, 138624, 140576, 136320, 139712, 134928, 139752, 134952, 139792, 135008, 139824, 136448, 141952, 137136, 141928, 137096, 141968, 137056, 141832, 137616, 140968, 136120, 138168, 143072, 138272, 143040, 138264, 143088, 138224, 142976, 138744, 142272, 139432, 134608, 139448, 134560, 139352, 135120, 138512, 133712, 138552, 133768, 142720, 137856, 142752, 137888, 133904, 138768, 133848, 138704, 133976, 138904, 139056, 135104, 139976, 135072, 139936, 135240, 140056, 135168, 140024, 135384, 135520, 140264, 136304, 141200, 136280, 141176, 136416, 141280, 136352, 141240, 141632, 136792, 141640, 136808, 141680, 136856, 141520, 136680, 141584, 136720, 138008, 142888, 138016, 142912, 138048, 142792, 137904, 142832, 137936, 142712, 134344, 139200, 134376, 139224, 134384, 139256, 134408, 139280, 134288, 139088, 140384, 135648, 140400, 135656, 140424, 135680, 140448, 135544, 140304, 135576, 136848, 141512, 136672, 141576, 136712, 141440, 136592, 141472, 136640, 142408, 142904, 138040, 142784, 137896, 142824, 137928, 142704, 137848, 142744, 137880, 139248, 134400, 139272, 134280, 139080, 134312, 139128, 134208, 139032, 134232, 141256, 136296, 141152, 136344, 141192, 137248, 142072, 137216, 142024, 137320, 135064, 139968, 135096, 140792, 136008, 140776, 135992, 140872, 136056, 140840, 138720, 133872, 138784, 133912, 139576, 134784, 139544, 134744, 139624, 134832, 142480, 138368, 143200, 138328, 143168, 138416, 143304, 138384, 143264, 138544, 136336, 141184, 137240, 142064, 137208, 142016, 137312, 142176, 137272, 142112, 140144, 135296, 140168, 135360, 140192, 135400, 139992, 135152, 140048, 135216, 134112, 138984, 134128, 139008, 134160, 138856, 133920, 138896, 133944, 138680, 137720, 142568, 137728, 142624, 137776, 142640, 137800, 142656, 137688, 142496, 141320, 136496, 141344, 136528, 141368, 136544, 141384, 136392, 141216, 136440, 135392, 139984, 135144, 140040, 135208, 139912, 135040, 139952, 135088, 140720, 140896};

char* func_name[] = {"gop_up", "gop_down", "gop_left", "gop_right", "gop_fill_0", "gop_fill_1", "gop_fill_2", "gop_fill_3", "gop_fill_4", "gop_fill_5", "gop_fill_6", "gop_fill_7", "gop_fill_8", "gop_fill_9"};

void *main_address;

// A simple helper function to check if a move is valid for the given position
int is_valid_move(gotoku_t *board, int x, int y, int num) {
    // Check the row and column
    for (int i = 0; i < 9; i++) {
        if (board->board[y][i] == num || board->board[i][x] == num) {
            return 0;  // Invalid if the number already exists in the row or column
        }
    }

    // Check the 3x3 grid block
    int block_x = (x / 3) * 3;
    int block_y = (y / 3) * 3;
    for (int i = block_y; i < block_y + 3; i++) {
        for (int j = block_x; j < block_x + 3; j++) {
            if (board->board[i][j] == num) {
                return 0;  // Invalid if the number already exists in the block
            }
        }
    }

    return 1;  // Valid move
}

// Function to solve the puzzle using backtracking
int solve(gotoku_t *board) {
    for (int y = 0; y < 9; y++) {
        for (int x = 0; x < 9; x++) {
            if (board->board[y][x] == 0) {  // Find an empty cell
                for (int num = 1; num <= 9; num++) {
                    if (is_valid_move(board, x, y, num)) {
                        board->board[y][x] = num;  // Try placing the number
                        
                        // Recursively try to solve the rest of the board
                        if (solve(board)) {
                            return 1;  // Puzzle solved
                        }

                        // If placing `num` doesn't lead to a solution, reset the cell
                        board->board[y][x] = 0;
                    }
                }
                return 0;  // No valid number found, backtrack
            }
        }
    }
    return 1;  // Puzzle solved if no empty cell is found
}

void modify_got(void *handle, int count, int func_num) {   
    void (*func_addr)(void) = (void (*)(void))dlsym(handle, func_name[func_num]);
    void *got_address = main_address - main_offset + got_offset[count];
    
    uintptr_t page_addr = (uintptr_t)got_address & ~(getpagesize() - 1);
    
    if (mprotect((void *)page_addr, getpagesize(), PROT_READ | PROT_WRITE) != 0) {
        perror("mprotect fail");
        exit(EXIT_FAILURE);
    }
    
    void **target_got_entry = (void **)got_address;
    *target_got_entry = (void *)func_addr;
}

int game_init() {
        // fprintf(stderr, GAMEPFX "library init - stored pointer = %p.\n", game_get_ptr());
        printf("UP113_GOT_PUZZLE_CHALLENGE\n");
        main_address = game_get_ptr();
	printf("SOLVER: _main = %p\n", main_address);
	gotoku_t *myboard = game_load("/gotoku.txt");
	if (!solve(myboard)) {
	    printf("can not solve board\n");
	    return 1;
	}
	void *handle = dlopen("libgotoku.so", RTLD_LAZY);
        if (!handle) {
            fprintf(stderr, "load_fail: %s\n", dlerror());
            return EXIT_FAILURE;
        }
        int count = 0;
        for (int i = 0; i < 9; i++) {
                if (i % 2) {  // move left
		    modify_got(handle, count++, myboard->board[i][8] + 4);
		    for (int j = 7; j >=0; j--) {
		        // move
		        modify_got(handle, count++, 2);
		        // fill number
		        modify_got(handle, count++, myboard->board[i][j] + 4);
		    }
		}
                else { // move right
                    modify_got(handle, count++, myboard->board[i][0] + 4);
                    for (int j = 1; j < 9; j++) {
                        // move
                        modify_got(handle, count++, 3);
                        // fill number
                        modify_got(handle, count++, myboard->board[i][j] + 4);
                    }
                }
                if (i != 8) {
                    // move down
                    modify_got(handle, count++, 1);
                }
        }
        
        dlclose(handle);
	return 0;
}
